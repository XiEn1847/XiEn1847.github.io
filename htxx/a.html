<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>sto xx orz</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<script src="/gifjs/gif.js"></script>
</head>
<body>


<input type="file" id="files" style="display:none" onchange="fileimport();"/>
<input type="button" id="import" value="导入"/>
<input type="button" id="export" value="导出"/>



<button type="button" class="btn">生成 GIF</button>
<img class="result-gif" width="667" height="375" src="" alt="">
<script type="text/javascript">

var txtdata;
function fileimport(){
	var selectedFile = document.getElementById("files").files[0];//获取读取的File对象
	console.log(selectedFile.length);
	var name = selectedFile.name;//读取选中文件的文件名
	var size = selectedFile.size;//读取选中文件的大小
	console.log("文件名:"+name+"大小："+size);
	var reader = new FileReader();//这里是核心！！！读取操作就是由它完成的。
	reader.readAsText(selectedFile,'gb2312');//读取文件的内容，注意编码方式
	reader.onload = function(){
		console.log(this.result);//当读取完成之后会回调这个函数，然后此时文件的内容存储到了result中。直接操作即可。
		$('<pre>' + this.result + '</pre>').appendTo('body');
		txtdata = this.result;
	};
}

let imgSore = {num: 0};
let imgNum = 0;

const w = 667;
const h = 375;
const delay = 45;


function initImg(name) {
	return new Promise(resolve => {
		let img = new Image();

		img.setAttribute("crossOrigin", "anonymous");
		img.onload = img.onerror = () => {
			resolve(img);
		};
		img.src = name;
		// cdn later

	})
}


function createImg(len) {
	// e.g. name = "2.png"

	let imgarray = [];
	for (let i = 1; i <= len; i++) {
		imgarray.push(initImg("/images/pray/" + i + ".png"));
	}
	return imgarray;
}


function createImgRoll(len) {
	// e.g. name = "2.png"

	let imgarray = [];
	for (let i = 1; i <= len; i++) {
		imgarray.push(initImg("/images/pray/" + i + ".png"));
	}
	for (let i = 1; i < len - 2; i++) {
		imgarray.push(initImg("/images/pray/" + (len - i) + ".png"));
	}
	return imgarray;
}




function drawTrapezoidV(ctx, img, x, y, w, h, factor) {
	var idx = 0, scale = img.width / w;
	for(; idx < w; idx++) {
		ctx.drawImage(img, ((idx + 0.5) * scale - 0.5)|0, 0,
						1, img.height,
						x + idx, y + (1 - ((w - idx) + idx * factor) / w) * h / 2,
						1, ((w - idx) + idx * factor) / w * h);
	//	ctx.drawimage(img, 0, 0, img.width, img.height,x, y, w, h);
	}
}



function createGif() {
	let imgarray = createImgRoll(8);
	let praygif = new GIF({
							width: w,
							height: h,
							workers: 2,
							quality: 10,
							workerScript: '/gifjs/gif.worker.js'
						});

	let canvas = document.createElement('canvas');
	canvas.width = w;
	canvas.height = h;
	let ctx = canvas.getContext('2d');

//	let upimg = new Image();
//	upimg.src = "/qwq1.png";

	Promise.all(imgarray).then(value => {
		value.forEach((value1, index) => {
	
			// draw
			ctx.clearRect(0, 0, w, h);
			ctx.setTransform(1, 0.21, 0, 1, 50, -40);
			
		//	drawTrapezoidV(ctx, upimg, 0, 0, 236, 334, 0.81);
			
			ctx.setTransform(1, 0, 0, 1, 0, 0);
			ctx.drawImage(value1, 0, 0);
	
			// insert as frame
			praygif.addFrame(ctx, {
				delay: delay,
				copy: true
			});
		});

		praygif.on('finished', function (blob) {
	
			console.log(blob);
			// window.open(URL.createObjectURL(blob));
			document.querySelector(".result-gif").src = URL.createObjectURL(blob);
		});
		praygif.render();
	});
}

document.querySelector(".btn").addEventListener("click", () => {
	createGif();
});


</script>
</body>
</html>
