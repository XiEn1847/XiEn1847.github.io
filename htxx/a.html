<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>sto xx orz</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<script src="/gifjs/gif.js"></script>
</head>
<body>

<span title="owo!"><h2>Keke Tang Praying Gif Generator</h2></span>

<h4>一些乱七八糟的须知</h4>

缝合了一整天代码整出来的奇怪小玩意<br/>
使用方法：先上传文件，然后点生成 GIF，稍等片刻（预计 5~20s）<br/>
参考的各种内容: 
<a href="https://yandex.com/search/?text=love+live+superstar+episode+3+no+subtitles&lr=200&src=suggest_Nin">#</a>
<a href="https://zh.clippingmagic.com">#</a>
<a href="https://www.zhangxinxu.com/wordpress/2018/05/js-custom-gif-generate/">#</a>
<a href="https://www.w3school.com.cn/tiy/t.asp?f=eg_html5_canvas_transform">#</a>
<a href="https://stackoverflow.com/questions/23624269/how-to-draw-an-image-in-trapezium-shape-using-canvas">#</a>
<a href="https://www.runoob.com/w3cnote/javascript-promise-object.html">#</a>
<a href="https://blog.csdn.net/sinat_31057219/article/details/70242265">#</a>
<a href="https://docs.fuyeor.com/answer/10090.html">#</a><br/>
fun fact: 图片出处是 lovelive sunshine episode3 9:43 处<br/>
帧间距小于 20ms 时好像并不能正常生成非常快的 gif，我也不知道为什么<br/>

<h4>生成器！</h4>

请选取一个图像文件: <input type="file" id="fileupl" name="fileupl"/>
<br/>
<div id="uplresult"></div>
<br/>

请设置两帧的间隔（现在是 <span id="speedviewer">45</span>ms）:
<input type="number" id="framespd" placeholder="45" min="1"/>
<button type="button" onclick="updFrameSpd()">更新</button>
<br/>

请设置图床（如果图片加载不出来请刷新页面后换一个）
<select onChange="changeImgOrigin(this.selectedIndex);">
<option >luogu</option>
<option >github</option>
<option selected="selected">jsdelivr</option>
</select>

<br/>

<button type="button" id="genGIF" disabled=true>生成 GIF</button>
<br/>
<img class="result-gif" width="667" height="375" src="" alt="">



<script type="text/javascript">

var uplimg;
var imgsrc = 2;
const w = 667;
const h = 375;
var delay = 45;


function initImg(name) {
	return new Promise(resolve => {
		let img = new Image();

		img.setAttribute("crossOrigin", "anonymous");
		img.onload = img.onerror = () => {
			resolve(img);
		};
		img.src = name;
		// cdn later

	})
}

/*
function createImg(len) {
	// e.g. name = "2.png"

	let imgarray = [];
	for (let i = 1; i <= len; i++) {
		imgarray.push(initImg("/images/pray/" + i + ".png"));
	}
	return imgarray;
}*/


function createImgRoll(src) {
	// e.g. name = "2.png"

	let imgarray = [];
	if (src == 2) {
		for (let i = 1; i <= 8; i++) {
			imgarray.push(initImg("https://gcore.jsdelivr.net/gh/XiEn1847/XiEn1847.github.io/images/pray/" + i + ".png"));
		}
		for (let i = 7; i >= 2; i--) {
			imgarray.push(initImg("https://gcore.jsdelivr.net/gh/XiEn1847/XiEn1847.github.io/images/pray/" + i + ".png"));
		}
	} else if (src == 1) {
		for (let i = 1; i <= 8; i++) {
			imgarray.push(initImg("https://XiEn1847.github.io/images/pray/" + i + ".png"));
		}
		for (let i = 7; i >= 2; i--) {
			imgarray.push(initImg("https://XiEn1847.github.io/images/pray/" + i + ".png"));
		}
	} else if (src == 0) {
		imgarray.push(initImg("https://cdn.luogu.com.cn/upload/image_hosting/ffxggnnh.png"));	//1
		imgarray.push(initImg("https://cdn.luogu.com.cn/upload/image_hosting/odj4jl2r.png"));	//2
		imgarray.push(initImg("https://cdn.luogu.com.cn/upload/image_hosting/5780sxer.png"));	//3
		imgarray.push(initImg("https://cdn.luogu.com.cn/upload/image_hosting/nv3f0u9v.png"));	//4
		imgarray.push(initImg("https://cdn.luogu.com.cn/upload/image_hosting/5d4vsyf8.png"));	//5
		imgarray.push(initImg("https://cdn.luogu.com.cn/upload/image_hosting/bmohioy4.png"));	//6
		imgarray.push(initImg("https://cdn.luogu.com.cn/upload/image_hosting/l3dpfxv4.png"));	//7
		imgarray.push(initImg("https://cdn.luogu.com.cn/upload/image_hosting/ixjzd5yu.png"));	//8
		
		imgarray.push(initImg("https://cdn.luogu.com.cn/upload/image_hosting/l3dpfxv4.png"));	//7
		imgarray.push(initImg("https://cdn.luogu.com.cn/upload/image_hosting/bmohioy4.png"));	//6
		imgarray.push(initImg("https://cdn.luogu.com.cn/upload/image_hosting/5d4vsyf8.png"));	//5
		imgarray.push(initImg("https://cdn.luogu.com.cn/upload/image_hosting/nv3f0u9v.png"));	//4
		imgarray.push(initImg("https://cdn.luogu.com.cn/upload/image_hosting/5780sxer.png"));	//3
		imgarray.push(initImg("https://cdn.luogu.com.cn/upload/image_hosting/odj4jl2r.png"));	//2
	}
	return imgarray;
}





function drawTrapezoidV(ctx, img, x, y, w, h, factor) {
	var idx = 0, scale = img.width / w;
	for (; idx < w; idx++) {
		ctx.drawImage(img, ((idx + 0.5) * scale - 0.5)|0, 0,
						1, img.height,
						x + idx, y + (1 - ((w - idx) + idx * factor) / w) * h / 2,
						1, ((w - idx) + idx * factor) / w * h);
	//	ctx.drawimage(img, 0, 0, img.width, img.height,x, y, w, h);
	}
}



function createGif() {
	let imgarray = createImgRoll(imgsrc);
	let praygif = new GIF({
							width: w,
							height: h,
							workers: 2,
							quality: 10,
							workerScript: '/gifjs/gif.worker.js'
						});

	let canvas = document.createElement('canvas');
	canvas.width = w;
	canvas.height = h;
	let ctx = canvas.getContext('2d');

	let upimg = new Image();
	upimg.src = uplimg;

	Promise.all(imgarray).then(value => {
		value.forEach((value1, index) => {
	
			// draw
			ctx.clearRect(0, 0, w, h);
			ctx.setTransform(1, 0.21, 0, 1, 50, -40);
			
			drawTrapezoidV(ctx, upimg, 0, 0, 236, 334, 0.81);
			
			ctx.setTransform(1, 0, 0, 1, 0, 0);
			ctx.drawImage(value1, 0, 0);
	
			// insert as frame
			praygif.addFrame(ctx, {
				delay: delay,
				copy: true
			});
		});

		praygif.on('finished', function (blob) {
	
			console.log(blob);
			// window.open(URL.createObjectURL(blob));
			document.querySelector(".result-gif").src = URL.createObjectURL(blob);
		});
		praygif.render();
	});
}

document.getElementById("genGIF").addEventListener("click", () => {
	createGif();
});


function ProcessFile(e) {
	var ufile = document.getElementById('fileupl').files[0];
	if (ufile) {
		var reader = new FileReader();
		reader.onload = function (event) {
			uplimg = event.target.result;
			var img = document.createElement("img");
			img.src = uplimg;//将图片base64字符串赋值给img的src
			img.height = 200;
			document.getElementById("uplresult").appendChild(img);
			document.getElementById("genGIF").disabled = false;
		};
	}
	reader.readAsDataURL(ufile);
}

function contentLoaded() {
	document.getElementById('fileupl').addEventListener('change', ProcessFile, false);
}
window.addEventListener("DOMContentLoaded", contentLoaded, false);

function updFrameSpd() {
	if (document.getElementById('framespd').value >= 1 && document.getElementById('framespd').value <= 1000) {
		delay = document.getElementById('framespd').value;
		document.getElementById('speedviewer').innerHTML = delay;
	}
}

function changeImgOrigin(new_id) {
	if (new_id == 0 || new_id == 1 || new_id == 2) {
		imgsrc = new_id;
	}
}

</script>
</body>
</html>
